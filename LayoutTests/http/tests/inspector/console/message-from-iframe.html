<script src="/inspector/resources/inspector-test.js"></script>
<script>
    // Utilities for page code.
    function addIFrame(iframeID, url) {
        let iframe = document.createElement("iframe");
        iframe.src = url;
        iframe.onload = () => console.log(`iframe ${iframeID} is loaded in ${location.href}`);
        document.body.appendChild(iframe);
    }

    function test() {
        // The purpose of these tests are to test that Web Inspector should receive console messages generated from various iframe tree correctly.

        const suite = InspectorTest.createAsyncSuite("MessageFromIFrame");

        // Utilities for test code.
        let callback = () => {};
        WI.consoleManager.addEventListener(WI.ConsoleManager.Event.MessageAdded, (event) => {
            InspectorTest.log(`Got message: ${event.data.message._messageText}`);
            callback();
        });

        function runMessageTest(resolve, expected, func) {
            let seen = 0;

            callback = () => {
                if (++seen === expected)
                    resolve();
            };

            InspectorTest.evaluateInPage(func);
        }

        suite.addTestCase({
            name: "MessageFromIFrame.SameOriginIFrame",
            description: "console message comming from same origin iframe",
            test: (resolve) => runMessageTest(resolve, 4, `addIFrame(1, "resources/console-messages.html")`),
        });

        suite.addTestCase({
            name: "MessageFromIFrame.CrossOriginIFrame",
            description: "console message comming from cross origin iframe",
            test: (resolve) => runMessageTest(resolve, 4, `addIFrame(2, "http://localhost:8000/inspector/console/resources/console-messages.html")`),
        });

        suite.addTestCase({
            name: "MessageFromIFrame.GrandChildSameOriginIFrameInSameOrigin",
            description: "console message comming from same origin grand-child iframe in same origin iframe",
            test: (resolve) => runMessageTest(resolve, 5, `addIFrame(3, "resources/embedded-same-origin.html")`),
        });

        suite.addTestCase({
            name: "MessageFromIFrame.GrandChildSameOriginIFrameInCrossOrigin",
            description: "console message comming from same origin grand-child iframe in cross origin iframe",
            test: (resolve) => runMessageTest(resolve, 5, `addIFrame(4, "http://localhost:8000/inspector/console/resources/embedded-cross-origin.html")`),
        });

        suite.runTestCasesAndFinish();
    }
</script>

<body onload="runTest()"></body>
